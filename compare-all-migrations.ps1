# Get all local migration files
$localFiles = Get-ChildItem "supabase/migrations/*.sql" | ForEach-Object {
    $filename = $_.Name
    # Extract version and name from filename
    if ($filename -match '^(\d+)_(.+)\.sql$') {
        @{
            version = $Matches[1]
            name = $Matches[2]
            filename = $filename
        }
    }
} | Sort-Object version

Write-Host "Local migrations count: $($localFiles.Count)" -ForegroundColor Cyan
Write-Host "Last local migration: $($localFiles[-1].filename)`n" -ForegroundColor Cyan

# Database migrations (from your earlier query)
$dbMigrations = @(
    @{version="20250915073334"; name=""},
    @{version="20250915073400"; name=""},
    @{version="20250915073416"; name=""},
    @{version="20250916031932"; name=""},
    @{version="20250916035535"; name=""},
    @{version="20250916035555"; name=""},
    @{version="20250916103756"; name=""},
    @{version="20250916110905"; name=""},
    @{version="20250916114851"; name=""},
    @{version="20250916115117"; name=""},
    @{version="20250917073321"; name=""},
    @{version="20250917073752"; name=""},
    @{version="20250917075632"; name=""},
    @{version="20250917080009"; name=""},
    @{version="20250917080340"; name=""},
    @{version="20250917081829"; name=""},
    @{version="20250917082317"; name=""},
    @{version="20250917082445"; name=""},
    @{version="20250917110949"; name=""},
    @{version="20250917115118"; name=""},
    @{version="20250918013410"; name=""},
    @{version="20250918020609"; name=""},
    @{version="20250918020648"; name=""},
    @{version="20250918021135"; name=""},
    @{version="20250918023054"; name=""},
    @{version="20250918025156"; name=""},
    @{version="20250918025220"; name=""},
    @{version="20250918025314"; name=""},
    @{version="20250918034201"; name=""},
    @{version="20250918040347"; name=""},
    @{version="20250918041816"; name=""},
    @{version="20250918074624"; name=""},
    @{version="20250918084609"; name=""},
    @{version="20250918120529"; name=""},
    @{version="20250918121503"; name=""},
    @{version="20250920082301"; name=""},
    @{version="20250920113817"; name=""},
    @{version="20250920113843"; name=""},
    @{version="20250920113921"; name=""},
    @{version="20250920114225"; name=""},
    @{version="20250920114259"; name=""},
    @{version="20250920114327"; name=""},
    @{version="20250920114352"; name=""},
    @{version="20250921022831"; name=""},
    @{version="20250922035450"; name=""},
    @{version="20250923025910"; name=""},
    @{version="20250923030302"; name=""},
    @{version="20250923032447"; name=""},
    @{version="20250923063940"; name=""},
    @{version="20250923064949"; name=""},
    @{version="20250923065024"; name=""},
    @{version="20250923080547"; name=""},
    @{version="20250923084038"; name=""},
    @{version="20250923104239"; name=""},
    @{version="20250923104655"; name=""},
    @{version="20250923120320"; name=""},
    @{version="20250924021410"; name=""},
    @{version="20250924021648"; name=""},
    @{version="20250924022921"; name=""},
    @{version="20250924023508"; name=""},
    @{version="20251004083923"; name=""},
    @{version="20251004085029"; name=""},
    @{version="20251004093920"; name=""},
    @{version="20251004111840"; name=""},
    @{version="20251005120124"; name=""},
    @{version="20251008014129"; name=""},
    @{version="20251013050913"; name=""},
    @{version="20251014234147"; name=""},
    @{version="20251014234847"; name=""},
    @{version="20251015000537"; name=""},
    @{version="20251015011659"; name=""},
    @{version="20251015012818"; name=""},
    @{version="20251015012917"; name=""},
    @{version="20251015014102"; name=""},
    @{version="20251015020924"; name=""},
    @{version="20251015024458"; name=""},
    @{version="20251015180548"; name=""},
    @{version="20251015201402"; name=""},
    @{version="20251016013303"; name=""},
    @{version="20251016013919"; name=""},
    @{version="20251016020007"; name=""},
    @{version="20251016122101"; name=""},
    @{version="20251017164431"; name=""},
    @{version="20251021161410"; name=""},
    @{version="20251021162156"; name=""},
    @{version="20251022204932"; name=""},
    @{version="20251023115106"; name=""},
    @{version="20251023120512"; name=""},
    @{version="20251023125850"; name=""},
    @{version="20251023163133"; name=""},
    @{version="20251023171105"; name=""},
    @{version="20251023180915"; name=""},
    @{version="20251023190558"; name=""},
    @{version="20251023233925"; name=""},
    @{version="20251024001353"; name=""},
    @{version="20251024003143"; name=""},
    @{version="20251024012846"; name=""},
    @{version="20251024013422"; name=""},
    @{version="20251024120956"; name=""},
    @{version="20251024121631"; name=""},
    @{version="20251025170512"; name=""},
    @{version="20251025222626"; name=""},
    @{version="20251027110614"; name=""},
    @{version="20251027162204"; name=""},
    @{version="20251027182306"; name=""},
    @{version="20251027184131"; name=""},
    @{version="20251029171307"; name=""},
    @{version="20251029172045"; name=""},
    @{version="20251029212002"; name=""},
    @{version="20251030003527"; name=""},
    @{version="20251030030345"; name=""},
    @{version="20251030031711"; name=""},
    @{version="20251030032455"; name=""},
    @{version="20251030122754"; name=""},
    @{version="20251030141513"; name=""},
    @{version="20251030191407"; name=""},
    @{version="20251031173658"; name=""},
    @{version="20251031204611"; name=""},
    @{version="20251101012433"; name=""},
    @{version="20251101023244"; name=""},
    @{version="20251101112101"; name=""},
    @{version="20251101114956"; name=""},
    @{version="20251101120111"; name=""},
    @{version="20251101124649"; name=""},
    @{version="20251101130030"; name=""},
    @{version="20251104044654"; name="add_schedule_fields"},
    @{version="20251104143702"; name=""},
    @{version="20251104143752"; name=""},
    @{version="20251104160816"; name=""},
    @{version="20251105185633"; name=""},
    @{version="20251105202906"; name=""},
    @{version="20251105204321"; name=""},
    @{version="20251105205841"; name=""},
    @{version="20251106001222"; name=""},
    @{version="20251106173538"; name=""},
    @{version="20251106220318"; name=""},
    @{version="20251106220618"; name=""},
    @{version="20251106231006"; name=""},
    @{version="20251107030844"; name=""},
    @{version="20251107115712"; name=""},
    @{version="20251107224959"; name=""},
    @{version="20251107233039"; name=""},
    @{version="20251110143519"; name=""},
    @{version="20251111081636"; name=""},
    @{version="20251111090749"; name=""},
    @{version="20251111194056"; name=""},
    @{version="20251111232210"; name=""},
    @{version="20251113134617"; name="sync_payee_user_id"},
    @{version="20251113150148"; name="create_branch_bids"},
    @{version="20251114014137"; name="add_project_fields_to_bids"},
    @{version="20251114021027"; name=""},
    @{version="20251114042711"; name="fix_expense_amount_constraint"},
    @{version="20251117205528"; name="create_reports_tables"},
    @{version="20251117205553"; name="create_report_execution_function"},
    @{version="20251117205623"; name="create_reporting_views_fixed"},
    @{version="20251117205939"; name="seed_report_templates"},
    @{version="20251117212612"; name="fix_report_execution_in_operator"},
    @{version="20251117212848"; name="fix_report_execution_in_operator_v2"},
    @{version="20251117214008"; name="fix_report_execution_in_operator_v3"},
    @{version="20251117214211"; name="fix_report_execution_in_operator_final"},
    @{version="20251117214239"; name="fix_report_execution_in_operator_direct_array"},
    @{version="20251117214313"; name="fix_report_execution_in_operator_enum_cast"},
    @{version="20251117214337"; name="fix_report_execution_in_operator_no_format"},
    @{version="20251117214412"; name="fix_report_execution_jsonb_keys_check"},
    @{version="20251117222533"; name="add_time_entries_to_report_execution"},
    @{version="20251117225403"; name="add_time_entries_support_to_report_function"},
    @{version="20251117231009"; name="create_estimate_line_items_quote_status_view"},
    @{version="20251117231323"; name="add_estimate_line_items_to_report_execution"},
    @{version="20251117233707"; name="add_internal_costs_to_report_execution"},
    @{version="20251118131442"; name="add_line_item_category_fields_to_project_financials"},
    @{version="20251118132037"; name="fix_filter_column_mapping_and_boolean_conversion"},
    @{version="20251118135158"; name="simplify_boolean_filters"},
    @{version="20251118140318"; name="add_category_list_to_project_financials"},
    @{version="20251118140637"; name="add_array_matching_operators"},
    @{version="20251118141451"; name="seed_report_templates"},
    @{version="20251118144914"; name="add_employee_number_to_payees"},
    @{version="20251118145411"; name="add_employee_number_to_report_execution"},
    @{version="20251118150749"; name="fix_execute_simple_report_filter_check"},
    @{version="20251119171612"; name=""},
    @{version="20251119174102"; name=""},
    @{version="20251121034238"; name="create_contracts_storage_bucket"},
    @{version="20251121141456"; name=""},
    @{version="20251124135718"; name="add_project_category"},
    @{version="20251124135748"; name="update_reporting_views_category"},
    @{version="20251124135802"; name="add_general_admin_project"},
    @{version="20251124150825"; name="add_overhead_projects_auto_tools_meals"},
    @{version="20251124175220"; name=""},
    @{version="20251125011029"; name=""},
    @{version="20251125152333"; name=""},
    @{version="20251125153214"; name=""},
    @{version="20251125153734"; name=""},
    @{version="20251125154431"; name=""},
    @{version="20251125155231"; name=""},
    @{version="20251125155507"; name=""},
    @{version="20251125160304"; name=""},
    @{version="20251125162116"; name=""},
    @{version="20251125162913"; name=""},
    @{version="20251126192426"; name="add_do_not_exceed_to_projects"},
    @{version="20251126213100"; name="add_is_auto_generated_to_estimates"},
    @{version="20251127045003"; name=""},
    @{version="20251127045716"; name=""},
    @{version="20251127131214"; name=""},
    @{version="20251130000817"; name="fix_enum_filtering_in_execute_simple_report"},
    @{version="20251130001659"; name="add_revenue_variance_to_project_financials"},
    @{version="20251130001730"; name="update_revenue_templates"},
    @{version="20251130001740"; name="add_revenue_comparison_templates"},
    @{version="20251130012008"; name="add_project_number_to_templates"},
    @{version="20251130170749"; name="add_revenue_splits_migration"},
    @{version="20251130170922"; name="update_project_financials_view_revenue_splits"},
    @{version="20251130175936"; name="update_change_order_template_with_total_invoiced"},
    @{version="20251130183205"; name="create_get_profit_analysis_data"},
    @{version="20251130185007"; name="exclude_overhead_from_profit_analysis"},
    @{version="20251130185228"; name="fix_current_margin_calculation"},
    @{version="20251130221138"; name="add_actual_margin_field"},
    @{version="20251130221148"; name="add_actual_margin_to_reporting_view"},
    @{version="20251130221728"; name="fix_actual_margin_revenue_splits"},
    @{version="20251130221837"; name="fix_reporting_view_revenue_splits"},
    @{version="20251130222124"; name="add_revenue_triggers_for_margins"},
    @{version="20251130222411"; name="fix_get_profit_analysis_data_actual_margin"},
    @{version="20251201035354"; name="fix_contingency_remaining_calculation_with_cost"},
    @{version="20251201035441"; name="add_contingency_remaining_to_calculate_project_margins"},
    @{version="20251201035638"; name="revert_contingency_remaining_to_use_billed_amount"},
    @{version="20251201040855"; name="create_internal_labor_hours_view"},
    @{version="20251201040945"; name="add_internal_labor_hours_data_source"},
    @{version="20251201040947"; name="add_internal_labor_hours_template"},
    @{version="20251201041538"; name="fix_internal_labor_hours_unit_matching"},
    @{version="20251201041610"; name="fix_internal_labor_hours_aggregation"},
    @{version="20251201043729"; name=""},
    @{version="20251201142042"; name="add_lunch_tracking"},
    @{version="20251205140034"; name=""},
    @{version="20251205140245"; name=""},
    @{version="20251205140356"; name=""},
    @{version="20251207125514"; name=""},
    @{version="20251207132935"; name=""},
    @{version="20251208170237"; name=""},
    @{version="20251208193514"; name="add_phone_to_profiles"},
    @{version="20251208193536"; name="create_sms_messages_table"},
    @{version="20251209112044"; name="create_scheduled_sms_tables"},
    @{version="20251209112051"; name="scheduled_sms_functions"},
    @{version="20251209112101"; name="setup_scheduled_sms_cron"},
    @{version="20251209113943"; name=""},
    @{version="20251210142023"; name="training_module"},
    @{version="20251210194602"; name="add_training_status_to_report_execution"},
    @{version="20251210194733"; name="add_assigned_at_to_training_templates"},
    @{version="20251211012241"; name=""},
    @{version="20251217114752"; name=""},
    @{version="20251217130248"; name=""},
    @{version="20260108191339"; name="add_last_active_at_to_profiles"},
    @{version="20260108191355"; name="update_get_user_auth_status_with_activity"},
    @{version="20260112175539"; name="create_feature_flags"},
    @{version="20260112175545"; name="create_quickbooks_connection"},
    @{version="20260112175550"; name="create_quickbooks_oauth_states"},
    @{version="20260112175555"; name="add_quickbooks_to_receipts"},
    @{version="20260112175600"; name="enhance_quickbooks_sync_log"},
    @{version="20260112190037"; name="fix_quickbooks_oauth_states_rls"},
    @{version="20260112190406"; name="fix_quickbooks_oauth_states_rls_update"},
    @{version="20260112190822"; name="fix_quickbooks_oauth_states_select_policy"},
    @{version="20260112194122"; name="fix_receipts_approval_rls_policy"},
    @{version="20260112221858"; name="add_quickbooks_fields_to_payees"},
    @{version="20260120144823"; name="add_company_labor_settings"},
    @{version="20260120144825"; name="add_labor_cushion_fields"},
    @{version="20260120144916"; name="add_estimate_labor_summary"},
    @{version="20260121160437"; name="add_labor_cushion_views_v2"},
    @{version="20260121162110"; name="add_cushion_hours_capacity_v2"},
    @{version="20260122153556"; name="add_quickbooks_transaction_sync"},
    @{version="20260123031752"; name="add_textbelt_http_status_to_sms_messages"},
    @{version="20260123134119"; name=""},
    @{version="20260123134120"; name="dfd655c2-ad80-4e8a-86bf-b13c38211633"},
    @{version="20260123134432"; name=""},
    @{version="20260123134433"; name="ee649696-cb93-4de4-b8ce-8300a8c265bc"},
    @{version="20260123140237"; name=""},
    @{version="20260123140238"; name="9d936881-6393-4427-9ba3-2a5b42a2de53"},
    @{version="20260123141817"; name=""},
    @{version="20260123141818"; name="b6a438b8-452f-4472-aba2-8e10f0e8cf6b"},
    @{version="20260123143416"; name=""},
    @{version="20260123143417"; name="d82792a2-811c-4119-958e-40838a9daf8c"},
    @{version="20260123144832"; name=""},
    @{version="20260123144833"; name="f835934e-eaec-4300-8a67-b12e918fbeed"},
    @{version="20260123173407"; name="add_labor_cushion_to_project_financials_view"}
)

Write-Host "Database migrations count: $($dbMigrations.Count)" -ForegroundColor Yellow
Write-Host "Last DB migration: $($dbMigrations[-1].version)_$($dbMigrations[-1].name)`n" -ForegroundColor Yellow

# Compare
$dbVersions = $dbMigrations | ForEach-Object { $_.version }
$localVersions = $localFiles | ForEach-Object { $_.version }

# Find migrations in DB but not in local files
$dbNotInLocal = $dbVersions | Where-Object { $_ -notin $localVersions }
if ($dbNotInLocal.Count -gt 0) {
    Write-Host "ALERT: Migrations in DATABASE but NOT in local files:" -ForegroundColor Red
    $dbNotInLocal | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
} else {
    Write-Host "✓ All database migrations have local files" -ForegroundColor Green
}

# Find local files not in DB
$localNotInDb = $localVersions | Where-Object { $_ -notin $dbVersions }
if ($localNotInDb.Count -gt 0) {
    Write-Host "`nALERT: Migrations in LOCAL FILES but NOT in database:" -ForegroundColor Magenta
    $localNotInDb | ForEach-Object { Write-Host "  - $_" -ForegroundColor Magenta }
} else {
    Write-Host "✓ All local migrations exist in database" -ForegroundColor Green
}

if ($dbNotInLocal.Count -eq 0 -and $localNotInDb.Count -eq 0) {
    Write-Host "`n✅ PERFECT ALIGNMENT! All 279 migrations match!" -ForegroundColor Green
}
