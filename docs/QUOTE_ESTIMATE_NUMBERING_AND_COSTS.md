# Quote vs Estimate Numbering and Cost Display (Deep Dive)

## Numbering: QTE vs EST

- **Quote number** format: `{project}-QTE-{seq}-{n}` (e.g. `225-005-QTE-01-18`)
  - Stored in `quotes.quote_number`, displayed as "Quote #" on quote views and list cards.
  - Generated by `generate_quote_number` RPC (project number + QTE + sequence).

- **Estimate number** format: `{project}-EST-{seq}` (e.g. `225-005-EST-01`)
  - Stored in `estimates.estimate_number`, displayed on estimate views and in "View Estimate Details".
  - Generated by `generate_estimate_number` RPC.

A **quote** (QTE) is tied to one **estimate** (EST) via `quotes.estimate_id`. When showing costs for a quote, we must use that linked estimate, not "any estimate for the project."

---

## Bug Fixed: Wrong Estimate Used for "Est. Cost" on Quote Cards

**Problem:** On the Quotes list (mobile cards), "Est. Cost" and variance (over/under estimate) were computed using the **first estimate for the project** (`estimates.find(e => e.project_id === quote.project_id)`). If a project has multiple estimate versions (e.g. v1 and v2), that could be the wrong estimate.

**Result:** Est. Cost and variance could not match the estimate that actually backs the quote, so numbers (e.g. $11,000) could appear with no corresponding line in the estimate you’re looking at (e.g. paint).

**Fix:** The mobile card now uses:

- `getEstimateForQuote(quote)` — resolves estimate by `quote.estimate_id` first, then falls back to project.
- `getEstimateLineItemCost(quote)` — sums only the **estimate line items** that are linked to this quote’s line items (via `estimate_line_item_id` on quote line items) from that linked estimate.

So "Est. Cost" is the sum of estimate costs for the **same scope** as the quote, from the **correct** estimate.

---

## Where the Numbers Come From

### Quoted Cost (on quote card)

- **Source:** `quote.total` → from DB `quotes.total_amount`.
- **Meaning:** Total vendor-quoted cost for this quote (all line items).
- **Why a number might not appear in "paint" only:** Quoted Cost is the **full quote total**. If the quote covers multiple scopes (e.g. paint + drywall + flooring), you won’t see that full total as a single line under "paint" in the estimate. To see paint-only, use the quote/estimate line-item views or compare by category.

### Est. Cost (on quote card)

- **Source:** Sum of `estimate_line_items.total_cost` for the estimate line items that are linked to this quote’s line items, from the estimate given by `quote.estimate_id` (via `getEstimateLineItemCost`).
- **Meaning:** Estimated cost for the **same scope** as the quote, from the linked estimate.
- **If you don’t see a value:** The quote may have no line items with `estimate_line_item_id` set, or the linked estimate may have no matching line items → card shows "—".

### Variance (over/under estimate)

- **Formula:** `(quote.total - estCost) / estCost * 100`, where `estCost = getEstimateLineItemCost(quote)`.
- Only shown when both `quote.total` and linked-estimate matched cost are present and comparable.

---

## Quick Reference

| Item        | Source / Rule |
|------------|----------------|
| Quote #     | `quotes.quote_number` (e.g. 225-005-QTE-01-18) |
| Estimate #  | `estimates.estimate_number` (e.g. 225-005-EST-01) |
| Quoted Cost | `quote.total` (= `quotes.total_amount`) — full quote total |
| Est. Cost   | Sum of linked estimate line item costs for this quote’s scope (`getEstimateLineItemCost`, uses `quote.estimate_id`) |
| Variance    | (Quoted Cost − Est. Cost) / Est. Cost, using the **linked** estimate |

---

## If a Number Still Doesn’t Match

1. **Check the linked estimate:** Quote form and quote view use the estimate selected for that quote (`quote.estimate_id`). Confirm you’re looking at that estimate’s line items (e.g. paint).
2. **Check line-item links:** Quote line items should have `estimate_line_item_id` pointing to the estimate line items they’re quoting. Missing links cause Est. Cost to be "—" or partial.
3. **Check total vs scope:** A value like $11,000 on the card is the **whole quote** total. To tie it to paint only, compare quote line items (and estimate line items) filtered by category/description (e.g. paint).
