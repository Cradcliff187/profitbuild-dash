# Validate that local migrations match Supabase database
# This prevents the migration sync issue from occurring

name: Validate Migration Sync

on:
  pull_request:
    paths:
      - 'supabase/migrations/**'
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Count local migration files
        id: local_count
        run: |
          LOCAL_COUNT=$(find supabase/migrations -name "*.sql" | wc -l)
          echo "count=$LOCAL_COUNT" >> $GITHUB_OUTPUT
          echo "Local migration files: $LOCAL_COUNT"
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Validate migration sync
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "‚ö†Ô∏è  If this check fails, run the migration sync script locally"
          echo "Local files: ${{ steps.local_count.outputs.count }}"
          echo "Database migrations will be checked by Supabase Preview"
      
      - name: Validate UUID-suffixed migration files
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          UUID_FILES=$(find supabase/migrations -name "*-*-*-*-*.sql")
          
          if [ -z "$UUID_FILES" ]; then
            echo "‚úÖ No UUID-based migration files found"
            exit 0
          fi
          
          echo "üîç Found UUID-suffixed migration files, validating against database..."
          echo ""
          
          # Get list of migrations from database
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "‚ö†Ô∏è  Cannot validate: SUPABASE_ACCESS_TOKEN or SUPABASE_PROJECT_ID not set"
            echo "Skipping UUID validation (assumes files are valid)"
            exit 0
          fi
          
          # Fetch database migrations via Supabase API
          DB_MIGRATIONS=$(curl -s \
            "https://api.supabase.com/v1/projects/$SUPABASE_PROJECT_ID/database/migrations" \
            -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" | jq -r '.[].version' 2>/dev/null || echo "")
          
          if [ -z "$DB_MIGRATIONS" ]; then
            echo "‚ö†Ô∏è  Could not fetch database migrations for validation"
            echo "Skipping UUID validation (assumes files are valid)"
            exit 0
          fi
          
          # Validate each UUID file exists in database
          INVALID_FILES=""
          for file in $UUID_FILES; do
            # Extract timestamp from filename (first 14 digits)
            TIMESTAMP=$(basename "$file" | grep -o '^[0-9]\{14\}')
            
            if ! echo "$DB_MIGRATIONS" | grep -q "^$TIMESTAMP"; then
              INVALID_FILES="$INVALID_FILES\n  - $file (timestamp: $TIMESTAMP)"
            fi
          done
          
          if [ -n "$INVALID_FILES" ]; then
            echo "‚ùå Found UUID-suffixed files that don't exist in database:"
            echo -e "$INVALID_FILES"
            echo ""
            echo "These files should be removed or their timestamps corrected."
            exit 1
          fi
          
          echo "‚úÖ All UUID-suffixed files validated against database"
          echo "Files are Lovable-generated and exist in the database"
